<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://blog.drogue.io/main.css">

    <title>(Re)introducing Drogue TLS &mdash; Drogue IoT</title>

    
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.drogue.io/rss.xml">
    

    
    <style>
        .hero-body {
            padding: 0;
        }
        .header-image {
            width: 100%;
            max-width: unset;

            height: auto;
            min-height: 32px;
            max-height: 33vh !important;

            object-fit: contain;
            object-position: left center;
            background-color: #8cc73f;
        }
    </style>
    <link rel="icon" type="image/svg+xml" href="https://blog.drogue.io/favicon.svg">
    

    <meta name="description" content="As we all know, the S in IoT stands for security. However, one reason IoT has a bad security track record is that it consumes a lot of resources and is not that easy to setup. One piece of this puzzle is having good client side libraries for doing TLS. Read on to learn more about how you can secure your device to cloud communication.
">


<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@DrogueIoT" />
<meta name="twitter:title" content="(Re)introducing Drogue TLS" />
<meta name="twitter:description" content="As we all know, the S in IoT stands for security. However, one reason IoT has a bad security track record is that it consumes a lot of resources and is not that easy to setup. One piece of this puzzle is having good client side libraries for doing TLS. Read on to learn more about how you can secure your device to cloud communication.
">
<meta name="twitter:image" content='https://blog.drogue.io/default_social_image.png'>


<meta property="og:type" content="article" />
<meta property="og:site_name" content="Drogue IoT">
<meta property="og:title" content="(Re)introducing Drogue TLS">
<meta property="og:url" content="https://blog.drogue.io/secure-device-to-cloud">
<meta property="og:description" content="As we all know, the S in IoT stands for security. However, one reason IoT has a bad security track record is that it consumes a lot of resources and is not that easy to setup. One piece of this puzzle is having good client side libraries for doing TLS. Read on to learn more about how you can secure your device to cloud communication.
">
<meta property="og:image" content='https://blog.drogue.io/default_social_image.png'>


    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QVBDYPJX0S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-QVBDYPJX0S', { 'anonymize_ip': true });
    </script>
  </head>

<body>

<section class="hero pb-5">
  <div class="hero-body">
    <a href="https://blog.drogue.io">
      <img class="header-image" src="https://blog.drogue.io/header.svg" alt="Header image">
    </a>
  </div>
</section>

<section class="section">
  
  <div class="container is-fluid">
    <div class="columns is-multiline">

      <aside class="column is-one-quarter-fullhd">
      
        <div class="is-sticky">
          <h2 class="title is-2 is-block-fullhd is-skipped">Links</h2>
          <ul class="link-list">
            <li><a href="https://blog.drogue.io">Blog</a></li>
            <li><a href="https:&#x2F;&#x2F;drogue.io" target="_blank">Project Homepage</a></li>
            <li><a href="https:&#x2F;&#x2F;github.com&#x2F;drogue-iot" target="_blank">GitHub Organization</a></li>
            <li><a href="https:&#x2F;&#x2F;book.drogue.io" target="_blank">Documentation</a></li>
            <li><a href="https:&#x2F;&#x2F;matrix.to&#x2F;#&#x2F;#drogue-iot:matrix.org" target="_blank">Community Chat</a></li>
            <li><a href="https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UC7GZUy2hKidvY6V_3QZfCcA" target="_blank">YouTube</a></li>
            <li><a href="https:&#x2F;&#x2F;vimeo.com&#x2F;user1825398" target="_blank">Vimeo</a></li>
            <li><a href="https:&#x2F;&#x2F;twitter.com&#x2F;DrogueIoT" target="_blank">Twitter</a></li>
            <li><a href="https:&#x2F;&#x2F;sandbox.drogue.cloud" target="_blank">Sandbox</a></li>
            <li><a href="https:&#x2F;&#x2F;calendar.google.com&#x2F;calendar&#x2F;u&#x2F;0&#x2F;embed?src=ofuctjec399jr6kara7n0uidqg@group.calendar.google.com" target="_blank">Community Calls</a></li>
          </ul>
        </div>
      
      </aside>

      <div class="column is-half-fullhd is-two-thirds-tablet is-three-quarters-desktop is-full">
        
<article itemscope itemtype="http://schema.org/BlogPosting">

  <section class="content">
    <h1 class="title is-size-2" itemprop="name headline">(Re)introducing Drogue TLS</h1>
    <div class="subtitle has-text-grey">
    

<div class="post-info">

    <div class="post-info-item">
        <span>7 minute read</span>
        <meta itemprop="wordCount" content="1370">
    </div>

    
        <div class="post-info-item">
            <span itemprop="datePublished" content='2021-07-01'> 1 July 2021</span>
        </div>
    

    

    
        <div class="post-info-item">
        <span>by 

<span itemprop="author" itemscope itemtype="http://schema.org/Person">
<span itemprop="name">Bob McWhirter and Ulf Lilleengen</span>
</span>

</span>
        </div>
    

    <div class="post-info-item">
        <span><a href="&#x2F;secure-device-to-cloud&#x2F;#comments">comments</a></span>
    </div>

    

</div>


    </div>
  </section>

  <hr>

  <section class="content post-content" itemprop="articleBody">
    <p>As we all know, the S in IoT stands for security. However, one reason IoT has a bad security track record is that it consumes a lot of resources and is not that easy to setup. One piece of this puzzle is having good client side libraries for doing TLS. Read on to learn more about how you can secure your device to cloud communication.</p>
<span id="continue-reading"></span><h1 id="what-are-the-options">What are the options?</h1>
<p>There are no one solution fits all, and requirements for a hobby project is very likely different from installation in a secure facility. The approaches we've tried out so far is:</p>
<ul>
<li>No security - for hobby projects where you're just reporting temperature values to the cloud, security might not seem to be a big deal. However, if you're sending that data to some cloud service, chances are that the cloud service want your device to present some credentials. Since sending unencrypted credentials over a public network is a bad idea, this option is only viable in cases where you control the entire network where no one can sniff traffic. </li>
<li>Secured gateway to cloud - If you have a private network where you don't worry about someone sniffing out your credentials, you have the option of installing a local gateway or running a service on an existing gateway which forwards data over an encrypted link to a cloud service. This is useful if your device just cannot do encrypted traffic and you can be certain no one is sniffing credentials.</li>
<li>Secure device to cloud - This requires your device to be capable of encrypting data, potentially supporting a standardized protocol like TLS (Transport Layer Security).</li>
</ul>
<p>We'll explore the two latter options in this post.</p>
<h2 id="secured-gateway-to-cloud">Secured gateway to cloud</h2>
<p>If you have a too little RAM to do TLS on the device, and you are on a secure network, then you can setup a gateway between the device and cloud. One way to do that is to use <a href="http://www.haproxy.org/">HAProxy</a>, which is fairly simple to setup. </p>
<p>Here is an example configuration that you can append to the HAProxy config for proxying <code>Device -http-&gt; HAProxy -https -&gt; Drogue Cloud</code>:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>#---------------------------------------------------------------------
</span><span># main frontend which devices connect to
</span><span>#---------------------------------------------------------------------
</span><span>frontend main
</span><span>    bind *:80
</span><span>    default_backend drogue
</span><span>
</span><span>#---------------------------------------------------------------------
</span><span># Drogue IoT backend
</span><span>#---------------------------------------------------------------------
</span><span>backend drogue
</span><span>    balance      roundrobin
</span><span>    http-request set-header  Host http.sandbox.drogue.cloud
</span><span>    server       static      http.sandbox.drogue.cloud:443 check sni str(http.sandbox.drogue.cloud) ssl
</span></code></pre>
<p>The frontend configuration configures the incoming port bound to where devices can connect. The backend configuration 
configures the route to the Drogue IoT sandbox service. For the requests to be routed correctly, the HTTP Host header and the TLS Server Name (SNI) must be set to the destination host.</p>
<h2 id="secured-device-to-cloud">Secured device to cloud</h2>
<p>Doing TLS on devices is the preferred approach if you have the available RAM. Unfortunately, to use TLS in Rust embedded, is has been necessary to &quot;pollute&quot; your Rust project with an existing TLS library like mbed TLS, which is the old approach taken by <a href="https://github.com/drogue-iot/drogue-tls">drogue-tls</a>.</p>
<p>We've started a new implementation of TLS 1.3 in pure Rust (nicknamed BobTLS after the initial author), and replaced the mbedTLS-based version. The goal is to implement the TLS 1.3 specification in pure Rust, with async support. The project does not have any dependencies on other Drogue IoT projects, and can be used with any TCP stack, by implementing two traits used for I/O. In fact, there are implementations of these traits for some common runtimes, and you can find examples of using Drogue TLS with <a href="https://github.com/drogue-iot/drogue-tls/tree/main/examples/tokio">tokio</a> and <a href="https://github.com/drogue-iot/drogue-tls/tree/main/examples/embassy">embassy + smoltcp</a>, with trait implementations for <a href="https://github.com/drogue-iot/drogue-tls/tree/main/src/lib.rs">futures</a> I/O traits as well.</p>
<p>The project is still under development, but implements basic functionality to get connected to Drogue IoT Cloud, such as Server Name Indication (SNI) extension. Critical features such as certificate validation and client certificate authentication is still on the <a href="https://github.com/drogue-iot/drogue-tls/issues">TODO list</a>. </p>
<h3 id="why-tls-1-3">Why TLS 1.3?</h3>
<p>TLS 1.3 is simpler and easier to implement than TLS 1.2. This is partially because there are only a single cipher suite that needs implementing (TLS_AES_128_GCM_SHA256), which is also not too resource demanding for embedded devices, but also because there are fewer mandatory extensions.</p>
<h3 id="where-does-my-ram-go">Where does my RAM go?</h3>
<p>We've tried to keep the memory footprint of <code>drogue-tls</code> small. The overhead of a TLS connection is minimal, and correlates with the desired buffer size. To properly support any TLS compliant endpoint, the chosen buffer size should be at least the maximum TLS frame size, 16kB. However, if you know your application will not be sending much data, you can get away with less. Given the focus on embedded, the primary goal has been to make it small rather than fast.</p>
<p>Since Drogue TLS is built using async, the futures also require some stack allocation. However, since <a href="https://github.com/embassy-rs/embassy">embassy</a> uses static futures for the tasks, we know the memory usage at compile time (BSS).</p>
<p>As an example, memory usage of <a href="https://github.com/drogue-iot/drogue-tls/tree/main/examples/embassy">embassy + smoltcp</a> binary, compile to the <code>x86_64-unknown-linux-gnu</code> target, looks like this without TLS:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ size target/release/ping-embassy-net
</span><span>   text    data     bss     dec     hex filename
</span><span>1094295   42040   16880 1153215  1198bf target/release/ping-embassy-net
</span></code></pre>
<p>Whereas with TLS enabled using a 16 kB record buffer, the memory usage increases (difference shown in the last row).</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ size target/release/ping-embassy-net
</span><span>   text     data     bss      dec     hex filename
</span><span>1175083    44392   37296  1256771  132d43 target/release/ping-embassy-net
</span><span>     8%       5%    2.2x       8%
</span></code></pre>
<p>Although the BSS increases to 2.2x, the 16kB is a large fraction of that increase. The BSS overhead of the library itself is about 4 kB when enabling TLS with a 16 kB record buffer. The same overhead can be observed when compiling to ARM architectures.</p>
<p>We have not yet look at flash usage, so there are probably improvements to be made there as well.</p>
<h3 id="what-about-drogue-device">What about Drogue Device?</h3>
<p>Drogue Device now supports TLS, and the example using <a href="https://github.com/drogue-iot/drogue-device/tree/main/examples/nrf52/microbit-esp8266">micro:bit + ESP8266 WiFi</a> is now using Drogue TLS to connect directly to the <a href="https://sandbox.drogue.cloud/">sandbox</a>.</p>
<p>We want Drogue Device to provide a simple way to get started with IoT, so having a simple API to use networking is important. As an example, the following code joins the wifi network, creates a regular <code>Socket</code> before wrapping it in a <code>TlsSocket</code> which implements the same trait as a regular <code>Socket</code>.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let mut</span><span> wifi = device.wifi.</span><span style="color:#96b5b4;">mount</span><span>((), spawner);
</span><span>wifi.</span><span style="color:#96b5b4;">join</span><span>(Join::Wpa {
</span><span>    ssid: </span><span style="color:#d08770;">WIFI_SSID</span><span>,
</span><span>    password: </span><span style="color:#d08770;">WIFI_PSK</span><span>,
</span><span>})
</span><span>.await
</span><span>.</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">Error joining wifi</span><span>&quot;);
</span><span>log::info!(&quot;</span><span style="color:#a3be8c;">WiFi network joined</span><span>&quot;);
</span><span>
</span><span style="color:#b48ead;">static mut </span><span style="color:#d08770;">TLS_BUFFER</span><span>: [</span><span style="color:#b48ead;">u8</span><span>; </span><span style="color:#d08770;">16384</span><span>] = [</span><span style="color:#d08770;">0</span><span>; </span><span style="color:#d08770;">16384</span><span>];
</span><span style="color:#b48ead;">let</span><span> socket = Socket::new(wifi, wifi.</span><span style="color:#96b5b4;">open</span><span>().await);
</span><span style="color:#b48ead;">let</span><span> socket = TlsSocket::wrap(socket,
</span><span>    TlsContext::new(rng,
</span><span>        </span><span style="color:#b48ead;">unsafe </span><span>{ &amp;</span><span style="color:#b48ead;">mut </span><span style="color:#d08770;">TLS_BUFFER </span><span>}) </span><span style="color:#65737e;">// We guarantee buffer to only be used by TLS
</span><span>        .</span><span style="color:#96b5b4;">with_server_name</span><span>(</span><span style="color:#d08770;">HOST</span><span>));
</span></code></pre>
<p>Because they implement the same trait, it's easy to write logic that does not have to care about the connection being over TCP or TLS.</p>
<h2 id="future-work">Future work</h2>
<p>As mentioned, Drogue TLS is still under development, with some critical features missing. However, we hope to see interest from the community and hope to collaborate on improving the TLS support for Rust embedded.</p>
<p>Another piece of security we have not yet discussed is the security of the device itself. If the device is installed in a public location, you also need to make sure someone cannot simply connect to it physically and extract the credentials from flash. This is a topic on its own that we'll try to cover in a later post, but newer generation microcontrollers allow you to define secure areas of flash to prevent extraction of credentials.</p>
<h1 id="summary">Summary</h1>
<p>In this post we've gone through two options for securing device to cloud communication. One is by deploying a local gateway such as <a href="http://www.haproxy.org/">HAProxy</a> to handle the secure communication. The other is to encrypt data on the device, using the new <a href="https://github.com/drogue-iot/drogue-tls">Drogue TLS</a> library. Finally, we've seen how you can use Drogue TLS with <a href="https://github.com/drogue-iot/drogue-device">Drogue Device</a>.</p>

  </section>

</article>

    </div>

    <aside class="column is-hidden-mobile is-one-third-tablet is-one-quarter-desktop">
      
<div class="box is-sticky ml-5">
  <div class="title is-size-3"><a href="#">Table of contents</a></div>
  <nav class="menu">
    <ul class="menu-list">
      
      <li>
        <a data-for="what-are-the-options" href="https://blog.drogue.io/secure-device-to-cloud/#what-are-the-options">What are the options?</a>
        
        <ul class="menu-list">
          
          <li>
            <a data-for="secured-gateway-to-cloud" href="https://blog.drogue.io/secure-device-to-cloud/#secured-gateway-to-cloud">Secured gateway to cloud</a>
          </li>
          
          <li>
            <a data-for="secured-device-to-cloud" href="https://blog.drogue.io/secure-device-to-cloud/#secured-device-to-cloud">Secured device to cloud</a>
          </li>
          
          <li>
            <a data-for="future-work" href="https://blog.drogue.io/secure-device-to-cloud/#future-work">Future work</a>
          </li>
          
        </ul>
        
      </li>
      
      <li>
        <a data-for="summary" href="https://blog.drogue.io/secure-device-to-cloud/#summary">Summary</a>
        
      </li>
      
    </ul>
  </nav>
</div>

    </aside>

    </div>
  </div>

  
</section>

<footer class="footer">
  <div class="content has-text-centered">
    <p>
      <strong>Drogue IoT</strong>
  </div>
</footer>

<script src="https://blog.drogue.io/default.js"></script>

</body>

</html>
